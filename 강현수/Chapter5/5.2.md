# 5.2 트랜잭션 서비스 추상화
### 5.2.1 모 아니면 도
우리가 만든 사용자 레벨 업그레이드 서비스가 작업 도중 예외가 발생하여 중단된다면, 중간에 작업하던 결과들은 어떻게 될까? <br/>

UserService가 도중에 예외가 발생하도록 하는 테스트 클래스를 만들어보자. <br/>
```java
public class TestUserService extends UserService {

    private String id;

    public TestUserService(String id) {
        this.id = id;
    }

    @Override
    protected void upgradeLevel(User user) {
        if (user.getId().equals(this.id)) {
            throw new TestUserServiceException();
        }
        super.upgradeLevel(user);
    }

    static class TestUserServiceException extends RuntimeException {
    }
}
```

이제 과연 중간에 작업이 중단됐을 때, 그 전에 업그레이드했던 사용자가 그대로일지 원래 상태일지 확인해보자. <br/>
```java
@Test
public void upgradeAllOrNothing() throws Exception {
    //given (3번 사용자가 업그레이드를 시도할 때 예외를 발생시킨다)
    UserService testUserService = new TestUserService(users.get(3).getId());
    testUserService.setUserDao(this.userDao); //수동 DI
    userDao.deleteAll();
    for (User user : users) {
        userDao.add(user);
    }

    //when
    try {
        testUserService.upgradeLevels();
        fail("TestUserServiceException expected");
    } catch (TestUserServiceException e) {
    }

    //then (3번 사용자 전 사용자의 레벨이 원래 상태인가 확인)
    checkLevelUpgraded(users.get(1), false);
}
```

테스트를 실행해보면 `expected: BASIC but was: SILVER` 이라는 에러 메시지를 출력하면서 실패한다. 즉, 3번 사용자 도중에 에러가 났지만 이전 사용자들의 업그레이드는 유지된다는 것이다. <br/>
우리가 원하는 것은 모든 사용자에 대한 레벨 업그레이드 작업이 전체가 성공하든지 아니면 전체가 다 실패하든지 해야 한다. 중간에 예외가 발생해서 작업을 완료할 수 없다면 아예 작업이 시작되지 않은 것처럼 초기 상태로 돌려놔야 한다. 이것이 트랜잭션이다. <br/>

### 5.2.2 트랜잭션 경계설정
