# 3장 템플릿
## 3.1 다시 보는 초난감 DAO
기존에 있는 DAO 코드에는 DB 커넥션이라는 리소스에 대한 예외 처리가 구현되어 있지 않다.
try/catch/finally 를 이용하여 예외상황에서도 리소스를 제대로 반환할 수 있도록 하자.
## 3.2 변하는 것과 변하지 않는 것
모든 메소드마다 반복된다. 복사 붙여넣기 보다 좋은 방법이 없을까?
### 메소드 추출
변하는 부분을 메소드로 뺴는 것이다. 메소드 추출 리팩토링을 적용하는 경우에는 분리시킨 메소드를 다른 곳에서 재사용할 수 있어야 하는데, 이건 반대로 분리시키고
남은 메소드가 재사용이 필요한 부분이고, 분리된 메소드는 DAO 로직마다 새롭게 만들어서 확장되어야 하는 부분이기 때문이다.
### 템플릿 메소드 패턴의 적용
상속을 통해 기능을 확장해서 사용하는 부분이다.  변하지 않는 부분은 슈퍼클래스에 두고 변하는 부분은 추상 메소드로 정의해둬서 서브클래스에서 오버라이드하여
새롭게 정의해 쓰도록 하는 것이다.
하지만 DAO 로직마다 상속을 통해 새로운 클래스를 만들어야 한다는 점이 문제이다.
### 전략 패턴의 적용
오브젝트를 아예 둘로 분리하고 클래스 레벨에서는 인터페이스를 통해서만 의존하도록 만드는 전략 패턴이다.
변하는 부분을 별도의 클래스로 만들어 추상화된 인터페이스를 통해 위임하는 방식이다.
그러나 인터페이스, 특정 구현 클래스를 해당 클래스에서 알고 있기 때문에 OCP에 위배된다.
### DI 적용을 위한 클라이언트/컨텍스트 분리
클라이언트에게 의존성 연결을 위임한다. 전략 오브젝트를 만득로 컨텍스트를 호출하는 책임을 지고 있다.
### 마이크로 DI
> DI의 장점을 단순화해서 IoC 컨테이너의 도움 없이 코드 내에서 적용한 경우를 마이크로 DI라고도 한다. 또는 코드에 의한 DI라는 의미로 수동 DI라고 부를 수도 있다.
## 3.3 JDBC 전략 패턴의 최적화
두가지 문제점
* DAO 메소드마다 새로운 StatementStrategy 구현 클래스를 만들어야 한다는 점
* DAO 메소드에서 StatementStrategy에 전달할 User와 같은 부가적인 정보가 있는 경우 
구현 클래스를 메소드 안에 로컬 클래스로서 선언한다.
> 로컬 클래스는 선언된 메소드 내에서만 사용할 수 있다.
> 로컬 클래스는 클래스가 내부 클래스이기 때문에 자신이 선언된 곳의 정보에 접근할 수 있다는 점이 있다.
> 
로컬 클래스를 익명 내부 클래스로 변경
> **익명 내부 클래스**
> 상속할 클래스나 구현할 인터페이스를 생성자 대신 사용해서 다음과 같은 형태로 만들어 사용한다. 클래스를 재사용할 필요가 없고, 구현한 인터페이스 타입으로만
> 사용할 경우에 유용하다.
> new 인터페이스이름() { 클래스 본문 };
## 3.4 컨텍스트와 DI
모든 DAO에서 Context를 사용하게 하자.
### 빈 의존관계 변경
UserDao는 이제 JdbcContext에 의존하고 있다.
인터페이스를 사요해서 클래스를 자유롭게 변경할 수 있게 하지는 않았지만, JdbcContext를 UserDao와 DI 구조로 만들어야 할 이유
* JdbcContext가 스프링 컨테이너의 싱글톤 레지스트리에서 관리되는 싱글톤 빈이 되기 때문이다.
  * JdbcContext는 그 자체로 변경되는 상태정보 갖고 있지 않다.
  * 내부에 dataSource라는 인스턴스 변수 있지만, 읽기전용이므로 JdbcContext가 싱글톤이 되는 데 아무 문제 없다.
* JdbcConetext가 DI를 통해 다른 빈에 의존하고 있기 때문이다.
  * DI를 위해서는 주입되는 오브젝트와 주입받는 오브젝트 양쪽 모두 스프링 빈으로 등록되어야 한다.
  * 스프링이 생성하고 관리한느 IoC 대상이어야 DI에 참여할 수 있기 때문이다.
## 3.5 템플릿과 콜백
지금까지 UserDao와 StatementStrategy, JdbcContext를 이용해 만든 코드는 일종의 전략 패턴이 적용된 것이라고 볼 수 있다.
복잡하지만 바뀌지 않는 일정한 패턴을 갖는 작업 흐름이 존재하고 부분만 자주 바꿔서 사용해야 하는 경우 적합한 구조다.
전략 패턴의 기본 구조에 익명 내부 클래스를 활용한 방식이다.이런 방식을 스프링에서는 템플릿/콜백 패턴 이라고 부른다.

### 템플릿
> 프로그래밍에서는 고정된 틀 안에 바꿀 수 있는 부분을 넣어서 사용하는 경우에 템플릿이라고 부른다.

### 콜백
> 실행되는 것을 목적으로 다른 오브젝트의 메소드에 전달된느 오브젝트를 말한다.

### 편리한 콜백의 재활용
템플릿/콜백 방식에서 한 가지 아쉬운 점이 있다.
DAO 메소드에서 매번 익명 내부 클래스를 사용하기 때문에 상대적으로 코드를 작성하고 읽기가 조금 불편하다는 점이다.

