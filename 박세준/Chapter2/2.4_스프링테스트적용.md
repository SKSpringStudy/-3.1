# 스프링 테스트 적용

현재 테스트 코드는 어플리케이션 컨텍스트를 각 테스트 메소드가 작동할 때 마다 새로 만들고 있다.

어플리케이션 컨텍스트는 만들어질 때 모든 싱글톤 빈 오브젝트를 초기화한다.

어떤 빈은 오브젝트 생성 시에 자체적친 초기화 작업을 진행해 제법 많은 시간을
필요로 하기도 하고 많은 리소스를 할당하거나 독립적인 스레드를 띄우기도 한다.

이런 경우 테스트를 마칠 때마다 애플리케이션 켄텍스트 내의 빈이 할당한 리소스 등을
깔끔하게 정리해주지 않으면 다음 테스트에서 새로운 어플리케이션 컨텍스트를 만들면서 문제가
발생할 수 있다.

## 하나의 어플리케이션 컨테스트를 쓰면 안될까?
가능하다.

어플리케이션 컨텍스트 안의 빈은 싱글톤으로 작동하기 때문에 
여러 테스트가 어플리케이션 컨텍스트를 공유해서 사용한다고 문제되지 않는다.

기존 @BeforeEach에 있던 어플리케이션 컨텍스트를 아래와 같이 인스턴스로 선언해주자.
```java
@ExtendWith(SpringExtension.class)
@ContextConfiguration(classes = DaoFactory.class)
public class UserDaoTest {

    private UserDao dao;
    private User user1;
    private User user2;
    private User user3;

    @Autowired
    private ApplicationContext context;

    @BeforeEach
    void setUp() {
        this.dao = context.getBean("userDao", UserDao.class);
        this.user1 = new User ("gyumee","박성철", "springnol");
        this.user2 = new User ("leegw700", "이길원" , "springno2");
        this.user3= new User ("bumjin","박범진", "springno3" );
    }
```
JUnit5 부터는 @RunWith를 다음과 같이 사용하면된다.
```java
@RunWith(SpringJUnit4ClassRunner.class)
->
@ExtendWith(SpringExtension.class)
```

이렇게 어플리케이션 컨텍스트를 테스트 오브젝트끼리 공유하게 되면서 
맨처음 어플리케이션 컨텍스트를 생성할 때 빼고 테스트 시간이 감소하는 효과를 볼 수 있다.

이것은 테스트 메소드 사이의 컨텍스트만 적용되는게 아닌 테스트 클래스 사이에서도 같은 설정파일을 공유한다고
하면 같은 컨텍스트를 공유하게 해준다.

## DI와 테스트-스프링 컨테이너 없는 DI 테스트

```java
@Before
public void setUp() {
    dao = new UserDao();
    DataSource dataSource = new SingleConnectionDataSource "idbc:mysgi://localhost/testdb", "spring", "book", true);
    dao.setDataSource(dataSource);
}
```
위와 같이 직접 DataSource를 만들어 DI를 해주면 스프링 컨테이너 없이 DI 테스트를 할 수 있다.

스프링 컨테이너를 활용하여 테스트 코드를 짜면 어플리케이션 컨텍스트를 생성하기 때문에 
스프링 컨테이너 없이 순수 자바로 직접 DI를 하는 것보다 느리다.

- 항상 스프링 컨테이너 없이 테스트할 수 있는 방법을 우선적으로 고려하자
- 테스트를 위한 오브젝트 생성과 초기화가 간단하다면 이 방법을 우선 고려하자
- 하지만 여러 오브젝트와 복잡합 의존관계를 가지고 있다면 스프링 컨테이너를 활용해 DI 방식의 테스트를 하면 편리하다
- 개발환경 테스트환경 운영환경의 차이가 있을 수 있으니 테스트에 애플리케이션 컨텍스트를 활용해야 한다면 테스트
전용 설정파일을 따로 만들어 사용하자

# 2.5 학습 테스트로 배우는 스프링

테스트 코드를 작성하면서 새로운 기능을 다양한 케이스르 테스트해보면서 학습할 수도 있다.

장점
1. 다양한 조건에 따른 기능을 손쉽게 확인해 볼 수 있다
2. 학습 테스트 코드를 개발 중에 참고할 수 있다.
   - 예제 코드는 마지막 케이스만 남지만 테스트는 독립적으로 동작하기 때문에
   다양한 케이스를 남길 수 있다.
3. 프레임워크나 제품을 업그레이드할 때 호환성 검증을 도와준다
   - 학습 테스트를 만들어놓았다면 버전 업그레이드시 학습 테스트를 돌려보면
   새 업데이트 버전에 대해 기존 API가 문제 없이 잘 돌아가는지 확인가능하다.
4. 테스트 작성에 대한 좋은 훈련이 된다
5. 새로운 기술을 공부하는 과정이 즐거워진다.
   - 레퍼런스나 책을 읽는 것은 지루하지만 테스트 코드를 짜면서하면 훨씬 흥미롭다.

## 버그테스트
버그가 발생하면 그 오류를 가장 잘 드러낼 수 있는 테스트 코드를 작성하자

장점
1. 테스트로 만들어서 실패하게 하려면 어떤 이유 때문에 문제가 생겼는지 명확히 알아야되기 때문에
효과적으로 버그를 분석할 수 있음
   - 동등분할이나 경계값 분석을 적용해 볼 수 있음
2. 다시 같은 버그가 터진다해도 버그 테스트 덕분에 손쉽게 추적 가능

동등분할 : 어떤 작업의 결과의 종류가 true, false, 예외 발생 3가지라면 각 결과를 내는 입력 값이나 
상황의 조합을 만들어 모든 경우에 대해 테스트하기
경계값 분석 : 동등분할 범위의 경계에서 에러가 자주 발생하기 때문에 경계값 근처의 값을 이용해 테스트
하는 방법(보통 0이나 주변값, 정수 최대, 최소값 등으로 테스트해보면 도움이 많이 됨)